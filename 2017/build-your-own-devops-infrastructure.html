<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)

	Modified by Alex Fernández
	alexfernandez.github.io | @pinchito
-->
<html>
	<head>
		<title>Build Your Own DevOps Infrastructure</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="../css/main.css" />
		<link rel="shortcut icon" href="/favicon.png" type="image/png" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../css/ie8.css" /><![endif]-->
		<script>
		// Disable tracking if the opt-out cookie exists.
		var disableStr = 'ga-disable-UA-75898530-1';
		if (document.cookie.indexOf(disableStr + '=true') > -1) {
			  window[disableStr] = true;
		}
		// Opt-out function
		function gaOptout() {
			document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
			window[disableStr] = true;
		}
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-75898530-2', 'auto');
		ga('send', 'pageview');

		</script>
	</head>
	<body>

		<!-- Header -->
			<section id="header">
				<header>
					<span class="image avatar"><a href="../index.html"><img src="../pics/avatar.jpg" alt="Avatar" /></a></span>
					<h1 id="logo"><a href="../index.html">Alex Fernández</a></h1>
					<p>
					I am a developer known on Twitter as <a href="https://twitter.com/pinchito">pinchito</a>.
					</p>
					<p>
					This site uses (gasp!) cookies for gathering statistics.
					You can
						<a href="javascript:gaOptout()">disable them</a>.
					</p>
				</header>
				<!--
				<nav id="nav">
					<ul>
						<li><a href="#one" class="active">About</a></li>
						<li><a href="#two">Things I Can Do</a></li>
						<li><a href="#three">A Few Accomplishments</a></li>
						<li><a href="#four">Contact</a></li>
					</ul>
				</nav>
				<footer>
					<ul class="icons">
						<li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
						<li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
						<li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li>
						<li><a href="#" class="icon fa-github"><span class="label">Github</span></a></li>
						<li><a href="#" class="icon fa-envelope"><span class="label">Email</span></a></li>
					</ul>
				</footer>
				-->
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">

						<!-- One -->
							<section id="one">
								<div class="container">
									<header class="major">
										<h1>Build Your Own DevOps Infrastructure</h1>
										<p>Talk for FullStack London 2017<p>
									</header>
																				<div class="figure">
<img src="pics/build-otomo.jpg" title="Build your own Akira motorbike, source: https://commons.wikimedia.org/wiki/File:FIBD2016Otomo01.jpg" />

</div>
<h2 id="devops-infrastructure">DevOps Infrastructure</h2>
<p>Your company is using cloud services. You want to do DevOps because you think it's cool, so you install Jenkins somewhere and... What now exactly?</p>
<p>The foundational idea of DevOps is to treat infrastructure as code. You write code to manage servers, monitor services and automate all sysadmin-related tasks. So let us do that!</p>
<p>Come with us to <a href="https://skillsmatter.com/conferences/8264-fullstack-2017-the-conference-on-javascript-node-and-internet-of-things#program">FullStack 2017</a>, where you will learn how to build your own DevOps infrastructure. This companion post should help you make the most of the talk.</p>
<h3 id="requirements">Requirements</h3>
<p>The live demo uses Node.js, as befits a JavaScript event. We are using ES6, so if you are running Node.js version 7 or earlier you will need to start it with the <code>--harmony</code> flag.</p>
<p>We use <a href="https://aws.amazon.com/">Amazon Web Services</a> in the examples, but the same infrastructure can be built for any other cloud provider, as long as they have a working Node.js driver.</p>
<h2 id="code-talks">Code Talks</h2>
<p>In the talk we will build our own simplified infrastructure. A more complete example resides in the GitHub repo <a href="https://github.com/alexfernandez/infra">infra</a>. This is what we will analyze here.</p>
<h3 id="email">Email</h3>
<p>We use with a couple of helper libraries to simplify our job. They are simple adapters for the official libraries, and will be introduced as they are needed.</p>
<p>The first helper library will simplify the task of sending an email: <a href="https://github.com/alexfernandez/infra/blob/master/lib/email.js"><code>lib/email.js</code></a>. It has a very straightforward interface:</p>
<pre><code>email.send(subject, body, callback)</code></pre>
<p>We have to indicate the subject and the body to send, and it will invoke the callback with an error if it fails. Internally this adapter uses the <code>emailjs</code> npm library.</p>
<h3 id="log">Log</h3>
<p>First we will start with a <a href="https://github.com/alexfernandez/infra/blob/master/lib/log.js">log library</a>. It prints messages at several levels of severity:</p>
<ul>
<li><code>debug</code>: internal message, not printed unless we are debugging.</li>
<li><code>info</code>: a message that is usually shown.</li>
<li><code>notice</code>: an important message that must always be shown.</li>
<li><code>warning</code>: something went wrong but we might get over it.</li>
<li><code>error</code>: something went wrong.</li>
<li><code>fatal</code>: something went really wrong.</li>
</ul>
<h4 id="the-code">The Code</h4>
<p>Let us start with <code>log.info()</code>. So in our module we export a function that shows a message:</p>
<pre><code>exports.info = function(message)
{
    console.log(message);
}</code></pre>
<p>It will be used as follows:</p>
<pre><code>const log = require(&#39;./log.js&#39;);
log.info(&#39;Hello world&#39;);
  \=&gt; Hello world</code></pre>
<p>The last line marked with <code>\=&gt;</code> is the output of the program. Easy, right? We just need to add the remaining priorities, which will be similar except that <code>log.warning()</code> and <code>log.error()</code> will use <code>console.error()</code>.</p>
<p>At this point we have a very primitive logging library, when there are many good solutions out there. But we want our library to be proactive: send us by mail all errors in our code. This way we just have to log all runtime errors, with the confidence that we will receive them if they really happen.</p>
<pre><code>[...]
doSomethingAsync(error =&gt; {
    if (error) return log.error(&#39;We have encountered an error: &#39; + error);
}</code></pre>
<p>This is one of the core principles of DevOps: do not wait for someone to look over millions of logs, be proactive and notify the team that something went wrong. It is not hard to do:</p>
<pre><code>exports.error = function(message)
{
    console.error(message);
    const subject = &#39;ERROR: &#39; + message;
    const body = &#39;ERROR ERROR ERROR\n\n&#39; + message + &#39;\n\nPlease take a look&#39;;
    email.send(subject, body, error =&gt; {
        if (error) console.error(&#39;Could not send email &#39; + subject + &#39;: &#39; + error);
    });
}</code></pre>
<h4 id="possible-refinements">Possible Refinements</h4>
<p>We can improve the logging library substantially:</p>
<ul>
<li>We will probably want to show the date and priority along with the message.</li>
<li>Allowing parameters with <code>%s</code> would also be nice.</li>
<li>We could also use a test or two.</li>
</ul>
<p>See the <a href="https://github.com/alexfernandez/infra/blob/master/lib/log.js">complete code</a> for details. All in all we need 75 lines of code.</p>
<h3 id="monitor">Monitor</h3>
<p>Next we will build a very simple <a href="https://github.com/alexfernandez/infra/blob/master/lib/monitor.js">website monitor</a>. Its only task is to check if our website is up, and to notify us otherwise.</p>
<h4 id="the-code-1">The Code</h4>
<p>The library function in Node.js <code>http.get()</code> is a bit cumbersome: we have to check the return code, and also the status of the response to see if the website is up. We use the library <a href="https://www.npmjs.com/package/basic-request"><code>basic-request</code></a>, which simplifies the task of accessing a URL: just pass it the address and a callback that receives an error if the call failed, and a result with the website content.</p>
<pre><code>const request = require(&#39;basic-request&#39;)
const log = require(&#39;./log.js&#39;)
const website = &#39;http://pinchito.es/&#39;
exports.check = function() {
    request.get(website, error =&gt; {
        if (error) log.error(&#39;Website is down: &#39; + error);
    })
}</code></pre>
<p>Since we are using our log library, we just need to log an error if the website is down. Now we need to run the function every minute:</p>
<pre><code>exports.check();
setInterval(exports.check, 60000);</code></pre>
<p>And we are done! 10 lines of code that will warn us if our website goes down for any reason.</p>
<h4 id="possible-refinements-1">Possible Refinements</h4>
<p>This monitor is admittedly very crude. We will probably want something that can:</p>
<ul>
<li>Check multiple websites.</li>
<li>Warn only once when the website is down.</li>
<li>Notify us when the website is up again.</li>
<li>Has some tests.</li>
</ul>
<p>The <a href="https://github.com/alexfernandez/infra/blob/master/lib/monitor.js">final code</a> contains all improvements, in 74 lines of code.</p>
<h3 id="aws">AWS</h3>
<p>The second helper library is an adapter for the official <code>aws-sdk</code> library from Amazon, which has a, let's say, somewhat quirky interface.</p>
<p>Our adapter library <a href="https://github.com/alexfernandez/infra/blob/master/lib/aws.js"><code>lib/aws.js</code></a> has functions to:</p>
<ul>
<li>find out instance ids for a number of servers,</li>
<li>create and terminate instances,</li>
<li>and get the CPU load of an instance.</li>
</ul>
<p>It will become clear in a minute why these are needed.</p>
<h3 id="orchestrator">Orchestrator</h3>
<p>Next we will build our own orchestrator.</p>
<h4 id="why-orchestrate-ourselves">Why Orchestrate Ourselves?</h4>
<p>Load on our web applications is often variable. We may want to create servers during the day to handle the increased load, and destroy them at night when it goes down. Amazon AWS has its own <a href="https://aws.amazon.com/autoscaling/">Auto Scaling</a>, but it has several issues:</p>
<ul>
<li>It orchestrates based on the CPU load of existing servers, not on the CPU load that will result if we remove one.</li>
<li>It uses average CPU load, not median which is more robust.</li>
<li>It only works with Amazon's own balancers (ELB or ALB), not with custom solutions.</li>
<li>It only takes CPU load into account, not memory use or latency.</li>
</ul>
<p>They are explained in detail <a href="../2016/nginx-balancer.html#orchestration">here</a>. Our custom orchestrator can be fine-tuned as we see fit. No longer do we have to set the low CPU load at 40%; we can set a narrower range such as 80-90% so we make better use of our servers, or use other parameters.</p>
<h4 id="the-code-2">The Code</h4>
<p>First we need to get the load of our instances. They all have names that start with the prefix <code>server</code>, so we get their instance ids and then the load for each one:</p>
<pre><code>function getInstanceLoads(callback) {
    aws.getInstanceIds(&#39;server&#39;, (error, instanceIds) =&gt; {
        if (error) return callback(error);
        let tasks = instanceIds.map(instanceId =&gt; {
            return next =&gt; {
                aws.getCpuUsage(instanceId, minutes, next);
            };
        });
    });
}</code></pre>
<h4 id="possible-refinements-2">Possible Refinements</h4>
<ul>
<li>Add new instances to a balancer.</li>
<li>Remove old instances from the balancer (not really necessary, AWS removes them from the ELB when terminated).</li>
<li>Check median instead of average.</li>
<li>Use a JSON configuration file.</li>
</ul>
<p>The <a href="https://github.com/alexfernandez/infra/blob/master/lib/orchestrator.js">final code</a> has all of these except adding instances to the ELB, in 148 lines of code.</p>
<h2 id="where-to-go-from-here">Where To Go From Here</h2>
<p>The next obvious step for our DevOps infrastructure is to implement a continuous deployment system. While it may seem daunting, we are more than half-way there. All that we need to do is:</p>
<ul>
<li>get the list of servers to deploy to,</li>
<li>SSH into them and make them download the code.</li>
</ul>
<p>Combined with a tool such as <a href="http://strider-cd.github.io/">Strider CD</a>, which takes care of downloading and testing our code, we have a full continuous deployment environment!</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>Thanks to <a href="https://www.meetup.com/es-ES/MallorcaJS/events/240203995/">MallorcaJS</a> for inviting me to give an <a href="http://slides.com/alexfernandez/build-your-owndevops-infrastructure#/">early version of this talk</a>, where I had a lot of fun. Thanks in particular to <a href="http://hotelinking.com/">hotelinking</a> and <a href="https://twitter.com/tufosa">Diego Lafuente</a> for making it possible.</p>
<p>Thanks to <a href="https://twitter.com/lizrice">Liz Rice</a> for her talk on <a href="http://www.devopspro.ru/2016/liz_rice/">building containers from scratch</a>, which was the inspiration for this humble talk.</p>
								</div>
							</section>
							<section id="last">
								<div class="container">
									<p>
									Published on 2017-07-01. <a href="https://twitter.com/pinchito/">Comments, suggestions?</a>
									</p>
									<p>
									Back to the <a href="../index.html">index</a>.
									</p>
								</div>
							</section>

				<!-- Footer -->
					<section id="footer">
						<div class="container">
							<ul class="copyright">
								<li>&copy; <a href="mailto:alexfernandeznpm@gmail.com">Alex Fernández</a>. Distributed under the <a href="https://opensource.org/licenses/MIT">MIT license</a>.</li>
								<li>Original design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</section>

			</div>
	</body>
</html>
