<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>La arquitectura fluida</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="../css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../css/ie8.css" /><![endif]-->
	</head>
	<body>

		<!-- Header -->
			<section id="header">
				<header>
					<span class="image avatar"><a href="../index.html"><img src="../pics/avatar.jpg" alt="Avatar" /></a></span>
					<h1 id="logo"><a href="../index.html">Alex Fernández</a></h1>
					<p>
					I am a developer (little) known on Twitter as <a href="https://twitter.com/pinchito">pinchito</a>.
					</p>
				</header>
				<!--
				<nav id="nav">
					<ul>
						<li><a href="#one" class="active">About</a></li>
						<li><a href="#two">Things I Can Do</a></li>
						<li><a href="#three">A Few Accomplishments</a></li>
						<li><a href="#four">Contact</a></li>
					</ul>
				</nav>
				<footer>
					<ul class="icons">
						<li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
						<li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
						<li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li>
						<li><a href="#" class="icon fa-github"><span class="label">Github</span></a></li>
						<li><a href="#" class="icon fa-envelope"><span class="label">Email</span></a></li>
					</ul>
				</footer>
				-->
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">

						<!-- One -->
							<section id="one">
								<div class="container">
									<header class="major">
										<h1>La arquitectura fluida</h1>
										<p>O de cómo migrar sin penas<p>
									</header>
										<div class="figure">
<img src="pics/la-persistencia-de-la-memoria.jpg" title="La persistencia de la memoria" alt="Picture credit: Salvador Dalí" /><p class="caption">Picture credit: <a href="http://www.wikiart.org/en/salvador-dali/the-persistence-of-memory-1931">Salvador Dalí</a></p>
</div>
<h1 id="tras-la-arquitectura-perfecta">Tras la arquitectura perfecta</h1>
<p>En muchas empresas hay departamentos de arquitectura dedicados a decidir cómo se va a organizar cada proyecto de software. Deciden el diseño a alto nivel, en cuántas capas se dividirá, qué base de datos usar y otros detalles importantes.</p>
<p>¿Por qué cambiar la base de datos en cada proyecto? ¿Por qué no usamos siempre la misma? Para construir edificios no existe un material perfecto: a veces es mejor la piedra, otras el ladrillo y otras incluso el acero. Tampoco hay una forma perfecta para todos los edificios: cuadrados, rectángulos, cilindros y semiesferas se comportan de forma distinta bajo la carga. Lo mismo ocurre con los componentes de software: cada uno tiene unas restricciones operacionales diferentes, y se comporta mejor en ciertas circunstancias.</p>
<h3 id="qué-es-la-arquitectura">Qué es la arquitectura</h3>
<p>Puede que nos ayude a centrar la discusión si definimos qué es este negocio de &quot;arquitectura&quot; en software.</p>
<h2 id="requisitos-cambiantes">Requisitos cambiantes</h2>
<p>Un sistema de software tiene que poder evolucionar durante su vida útil.</p>
<h3 id="modas-en-arquitectura">Modas en arquitectura</h3>
<p>En los años 80, la moda en las empresas era tener una <a href="http://www.computerhistory.org/revolution/minicomputers/11/366/1946">minicomputadora</a> (del tamaño de un armario pequeño) y múltiples terminales conectados.</p>
<p>En los 90 se popularizaron las arquitecturas cliente-servidor.</p>
<p>A principios del siglo XXI llegaron las arquitecturas de tres capas: capa web, backend y base de datos.</p>
<p>En los años 10 las bases de datos NoSQL han adquirido protagonismo.</p>
<h2 id="requisitos-operacionales">Requisitos operacionales</h2>
<p>Las circunstancias en las que nuestro sistema tiene que trabajar cambian, para bien o para mal. Un producto exitoso a menudo dobla el número de usuarios en un año, o incluso en una mes: en 2013 <a href="http://techcrunch.com/2013/12/18/uber-lyft/">Uber</a> crecía al 400% por año, mientras que su competidora Lyft lo hacía a un ritmo todavía más vertiginoso que suponía multiplicar su facturación por 20 en un año.</p>
<h3 id="caso-práctico-mediasmart-mobile">Caso práctico: MediaSmart Mobile</h3>
<h3 id="planificación-de-capacidad">Planificación de capacidad</h3>
<p>En inglés: <em>capacity planning</em>.</p>
<h3 id="costes-bajos">Costes bajos</h3>
<h3 id="velocidad-de-migración">Velocidad de migración</h3>
<h3 id="migraciones-de-base-de-datos">Migraciones de base de datos</h3>
<h2 id="la-arquitectura-fluida">La arquitectura fluida</h2>
<p>¿Cuál es la solución? Nuestra humilde sugerencia es mantener la arquitectura del sistema fluida, sin tomar decisiones que comprometan su integridad. Al oir esto, un arquitecto de los de verdad, de los que juntan piedras, seguramente tendría problemas para contener la risa. ¿Cómo se pueden cambiar las vigas maestras de un edificio?</p>
<p>Los ingenieros de software tenemos una gran ventaja: no trabajamos con el mundo real, sino con software, que es infinitamente moldeable.</p>
<p>Si encontramos restricciones en esta moldeabilidad, es porque alguien no ha hecho bien su trabajo.</p>
<h3 id="reversibilidad-y-termodinámica">Reversibilidad y termodinámica</h3>
<p>En este punto vamos a tomar un desvío que nos llevará de viaje a la intemporal tierra de la termodinámica.</p>
<p>Seguro que has oído hablar de &quot;entropía&quot;: es un término muy popular entre los divulgadores científicos, que a menudo lo corrompen asignándole significados corrientes como &quot;desorden&quot;, &quot;irregularidad&quot; y similares. Es probable que no te sorprenda que la entropía tiene una definición muy precisa, o más bien varias definiciones equivalentes.</p>
<p>No es sencillo calcular la entropía de un sistema, y menos todavía medir los flujos de entropía que ocurren mientras evoluciona.</p>
<p>Por suerte, podemos tomar un atajo: un sistema reversible es, por definición, el que consigue que la entropía se mantenga en el mínimo posible. No por casualidad también es el más eficiente. Y además es muy fácil saber cuándo un sistema es reversible: cuando está en todo momento en equilibrio.</p>
<p>En 2012 exploré en <a href="../2012/reversible-engineering-part-1.html">estos</a> <a href="../2012/reversible-engineering-part-2.html">tres</a> <a href="../2012/reversible-engineering-part-3.html">artículos</a> (en inglés) una idea similar a la que he desarrollado aquí: la ingeniería reversible, o cómo trabajar siempre cerca del equilibrio.</p>
<h1 id="estrategias-de-migración">Estrategias de migración</h1>
<p>Llegamos ahora a la parte principal del artículo: el catálogo de estrategias. Vamos a describir varias técnicas que se pueden usar para realizar una migración, de las más bruscas a las que son completamente reversibles.</p>
<p>Todas las estrategias que vamos a describir están probadas en combate. Intentaremos ilustrar cada estrategia con un caso práctico, aunque curiosamente no es fácil encontrar publicaciones sobre migraciones. Por ello para la mayoría de ellas tendremos que recurrir a ejemplos internos de MediaSmart Mobile.</p>
<p>Aunque la mayoría de los ejemplos son de migraciones de bases de datos, las estrategias pueden usarse igualmente para cualquier migración, sea de código, de datos o de infraestructura. Las bases de datos son un ejemplo prototípico de arquitectura cliente/servidor, así que nos dan un marco de referencia bastante sólido sobre el que analizar cada estrategia.</p>
<p>La lista no es exhaustiva: seguramente el lector pueda imaginar algunas estrategias adicionales y perfectamente útiles. Puedes compartirlas al final del artículo.</p>
<p>Ilustraremos las estrategias relevantes con ejemplos de código de Node.js, muy apropiado para migraciones reversibles.</p>
<h2 id="quieres-decir-patrones">¿Quieres decir &quot;patrones&quot;?</h2>
<p>Tras el gran éxito del libro de Gamma <em>et al</em>, <em>Design Patterns</em>, la palabra &quot;patrón&quot; se usa (y se abusa) a menudo en el diseño de sistemas. Los patrones vienen a ser piezas que se deben usar cada una en su situación correspondiente. En nuestro caso, ante una migración podemos usar varias de las técnicas que vamos a describir, a nuestra elección.</p>
<p>Los elementos de juicio que usaremos para decidirnos por una o por otra son precisamente lo fluida que queramos que sea la migración, no la funcionalidad que queremos conseguir (que es siempre la misma). De ahí que prefiramos en nuestro caso el término &quot;estrategia&quot;, además de no estar viciado por el uso previo.</p>
<h2 id="catálogo-de-estrategias-de-servidor">Catálogo de estrategias de servidor</h2>
<p>En esta primera categoría tenemos estrategias que se implementan puramente en el servidor, sin tener que modificar el cliente salvo para reconfigurarlo.</p>
<h3 id="parar-y-arrancar">Parar y arrancar</h3>
<div class="figure">
<img src="pics/stop-migrate.jpg" alt="Stop and migrate" /><p class="caption">Stop and migrate</p>
</div>
<p>Ésta es la migración de toda la vida:</p>
<ul>
<li>se para el sistema,</li>
<li>se copia la base de datos antigua a la nueva (copia en frío),</li>
<li>se reconfiguran los clientes para que apunten a la nueva,</li>
<li>y se vuelve a arrancar el sistema.</li>
</ul>
<p>Esta estrategia requiere dejar de dar servicio, con lo que no es apropiada para situaciones de alta disponibilidad. Claramente no es realmente reversible, y además es un poco chapucera.</p>
<h4 id="código-de-ejemplo">Código de ejemplo</h4>
<p>El código de servidor es muy sencillo. Primero tenemos un fichero <code>settings.js</code> que almacena la configuración:</p>
<pre><code>module.exports = {
    redisAddress: &#39;redis.mydomain.com&#39;,
};</code></pre>
<p>El fichero intermedio <code>db.js</code> define las bases de datos que usaremos, en este caso <code>current</code>:</p>
<pre><code>var settings = require(&#39;./settings.js&#39;);
module.exports = {
    current: new RedisAdapter(settings.redisAddress),
};</code></pre>
<p>Finalmente, en cada sitio donde usemos la base de datos accederemos a<code>db.current</code>:</p>
<pre><code>var db = require(&#39;./db.js&#39;);
db.current.get(key, function(error, result) {
    ...
});</code></pre>
<h4 id="caso-práctico">Caso práctico</h4>
<p>El primer caso práctico que vamos a ver no es precisamente una migración de base de datos. En MediaSmart Mobile necesitábamos migrar nuestra infraestructura en la nube de Amazon (AWS), de una conexión no segura a la VPC (<em>Virtual Private Cloud</em>).</p>
<p>El 3 de marzo de 2015 realizamos la migración: primero creamos una réplica de todos los servidores en la VPC. A continuación paramos los servidores originales, y copiamos los datos a la VPC. Luego arrancamos los nuevos sevidores, y apuntamos el servidor DNS hacia ellos. Tras algunas horas de <em>downtime</em> estábamos arriba otra vez.</p>
<p>El día 5 de marzo nos reportaron problemas en producción, por lo que tuvimos que deshacer la migración. Por fortuna habíamos mantenido las instancias antiguas, así que fue cuestión de parar, volver a copiar los datos y arrancar otra vez. Por ironías de la vida, el problema no se resolvió con esta migración inversa, por lo que dedujimos que tenía otra causa. Curiosamente, una vez que nos quitamos de enmedio la causa más obvia (la migración), el problema real se hizo evidente de inmediato y no tenía nada que ver, sino que venía causado por un despliegue anterior.</p>
<p>El día 11 de marzo probamos de nuevo con la misma técnica, y de nuevo tras varias horas de <em>downtime</em> la migración estaba hecha. Como operamos en dos regiones de AWS, todavía teníamos que migrar la segunda región, cosa que hicimos el día 13 de marzo (viernes). Porque total, viernes 13: ¿qué podía salir mal? Y no somos supersticiosos.</p>
<h3 id="versión-de-sólo-lectura">Versión de sólo lectura</h3>
<h3 id="sincronización">Sincronización</h3>
<p>MediaSmart daystats</p>
<h3 id="copia-doble">Copia doble</h3>
<p>MediaSmart perfiles</p>
<h2 id="catálogo-de-estrategias-en-cliente">Catálogo de estrategias en cliente</h2>
<h3 id="decorador">Decorador</h3>
<h3 id="consulta-doble">Consulta doble</h3>
<h3 id="escritura-doble">Escritura doble</h3>
<h3 id="paso-temporizado-timed-rollover">Paso temporizado (timed rollover)</h3>
<p>MediaSmart stats aggregates</p>
<h3 id="conversión-in-situ">Conversión <em>in situ</em></h3>
<h2 id="catálogo-de-estrategias-en-broker">Catálogo de estrategias en broker</h2>
<h3 id="acceso-mediante-proxy">Acceso mediante proxy</h3>
<p>Instagram</p>
<h3 id="escritura-encolada">Escritura encolada</h3>
<h1 id="vamos-terminando">Vamos terminando</h1>
<h2 id="seguir-el-flujo">Seguir el flujo</h2>
<h2 id="migración-de-cualquier-tipo">Migración de cualquier tipo</h2>
<h2 id="el-equilibrio-inestable">El equilibrio inestable</h2>
								</div>
							</section>
							<section id="last">
								<div class="container">
									<p>
									Publicado originalmente en TodoJS el 2015-.
									</p>
									<p>
									Back to the <a href="../index.html">index</a>.
									</p>
								</div>
							</section>

				<!-- Footer -->
					<section id="footer">
						<div class="container">
							<ul class="copyright">
								<li>&copy; Alex Fernández. Distributed under the <a href="https://opensource.org/licenses/MIT">MIT license</a>.</li>
								<li>Original design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</section>

			</div>
	</body>
</html>
